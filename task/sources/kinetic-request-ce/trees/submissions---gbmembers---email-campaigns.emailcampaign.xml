<tree schema_version="1.0">
    <sourceName>Kinetic Request CE</sourceName>
    <sourceGroup>Submissions > gbmembers > email-campaigns</sourceGroup>
    <type>Tree</type>
    <status>Active</status>
    <taskTree builder_version="" schema_version="1.0" version="">
        <name>EmailCampaign</name>
        <author></author>
        <notes></notes>
        <lastID>47</lastID>
        <request>
            <task definition_id="system_start_v1" id="start" name="Start" x="41" y="11">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters></parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utility_json_to_xml_v1_18</task>
                </dependents>
            </task>
            <task definition_id="system_loop_head_v1" id="system_loop_head_v1_1" name="Loop over ids" x="623" y="486">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="data_source" label="Data Source:" menu="" required="true" tooltip="The source that contains the data to use to create each task in the loop.">&lt;%=@results['Json to xml']['XML']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="loop_path" label="Loop Path:" menu="" required="true" tooltip="The XPath statement to indicate what data records to process.">//node/node</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="var_name" label="Variable Name:" menu="" required="false" tooltip="The local variable name used to represent the data used in loop tasks.">recipient</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_loop_tail_v1_4</task>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_retrieve_v2_40</task>
                </dependents>
            </task>
            <task definition_id="system_loop_tail_v1" id="system_loop_tail_v1_4" name="Loop tail" x="620" y="665">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="type" label="Type:" menu="All,Some,Any" required="true" tooltip="How many loop processes must be completed before continuing?">All</parameter>
                    <parameter dependsOnId="type" dependsOnValue="Some" id="number" label="Number:" menu="" required="false" tooltip="If some, how many?"></parameter>
                </parameters>
                <messages></messages>
                <dependents></dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_update_v1" id="kinetic_request_ce_submission_update_v1_14" name="Update member" x="1071" y="623">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided).">&lt;%=@space['Slug']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission being updated.">&lt;%=@results['Retrieve member']["ID"]%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="state" label="State" menu="" required="false" tooltip="The value used to set the submission state.">&lt;%=@results['Retrieve member']['Core State']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="values" label="Values" menu="" required="false" tooltip="A JSON map of field names to values that should be set.">&lt;%=
emailsSentCount = 1
count=JSON.parse(@results['Retrieve member']['Values JSON'])['Emails Sent Count']
if !count.nil?
  emailsSentCount = count.to_i + 1
end
values = {}
values["Emails Sent Count"] = emailsSentCount 
values.to_json
%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_junction_v1_44</task>
                </dependents>
            </task>
            <task definition_id="utility_json_to_xml_v1" id="utility_json_to_xml_v1_16" name="Json to xml" x="440" y="437">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="json" label="JSON" menu="" required="true" tooltip="The JSON String to be converted to XML">&lt;%=@values['Recipients']%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_loop_head_v1_1</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_17" name="Create Temp file" x="881" y="-131">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
require "base64"

filename=@results['Work Directory']['output']+@results['Image filename']['output'].strip
File.open(filename, 'wb') do |file|
    file.write(Base64.decode64(@results['imageVal']['output']))
end
%&gt;
</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">amazon_s3_file_upload_v2_26</task>
                </dependents>
            </task>
            <task definition_id="utility_json_to_xml_v1" id="utility_json_to_xml_v1_18" name="Embedded Images Json to xml" x="164" y="-36">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="json" label="JSON" menu="" required="true" tooltip="The JSON String to be converted to XML">&lt;%=@values['Embedded Images']%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_get_answers_v2_33</task>
                </dependents>
            </task>
            <task definition_id="system_loop_head_v1" id="system_loop_head_v1_19" name="Loop over images" x="548" y="34">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="data_source" label="Data Source:" menu="" required="true" tooltip="The source that contains the data to use to create each task in the loop.">&lt;%=@results['Embedded Images Json to xml']['XML']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="loop_path" label="Loop Path:" menu="" required="true" tooltip="The XPath statement to indicate what data records to process.">//node/node</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="var_name" label="Variable Name:" menu="" required="false" tooltip="The local variable name used to represent the data used in loop tasks.">embeddedImage</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_loop_tail_v1_20</task>
                    <task label="" type="Complete" value="">utilities_echo_v1_24</task>
                </dependents>
            </task>
            <task definition_id="system_loop_tail_v1" id="system_loop_tail_v1_20" name="Loop images tail" x="688" y="178">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="type" label="Type:" menu="All,Some,Any" required="true" tooltip="How many loop processes must be completed before continuing?">All</parameter>
                    <parameter dependsOnId="type" dependsOnValue="Some" id="number" label="Number:" menu="" required="false" tooltip="If some, how many?"></parameter>
                </parameters>
                <messages></messages>
                <dependents></dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_23" name="Image filename" x="697" y="-131">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%
embeddedImage=@results['Loop over images']['Value']
imageTAG=embeddedImage[0..embeddedImage.index(":")-1]
imageVAL=embeddedImage[embeddedImage.index(":")+1..embeddedImage.length]

imageEXT=imageVAL[imageVAL.index("data:image/")+"data:image/".length..imageVAL.index(";")-1]
%&gt;&lt;%= imageTAG+"."+imageEXT%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_17</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_24" name="imageVal" x="552" y="-57">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
embeddedImage=@results['Loop over images']['Value']
imageVAL=embeddedImage[embeddedImage.index(":")+1..embeddedImage.length]
imageVAL[imageVAL.index(",")+1..imageVAL.length].sub('"','').sub('&amp;quot','')
%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_23</task>
                </dependents>
            </task>
            <task definition_id="amazon_s3_file_upload_v2" id="amazon_s3_file_upload_v2_26" name="Upload Image" x="893" y="-23">
                <version>2</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="region" label="Region" menu="" required="true" tooltip="Id of the region the inteded S3 server is located in.">&lt;%=  @space_attributes['AWS Region'].nil? ? "ap-southeast-2" : @space_attributes['AWS Region'] %&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="bucket" label="Bucket" menu="" required="true" tooltip="Name of the bucket to upload to.">gbmember-campaign-images</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="file_name" label="File Name" menu="" required="true" tooltip="Name of the file to upload.">&lt;%=@results['Image filename']['output']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="file_content" label="File Content" menu="" required="false" tooltip="String to upload as the contents of the new file."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="file_location" label="File Location to upload" menu="" required="false" tooltip="Path to file to upload">&lt;%= @results['Work Directory']['output']+@results['Image filename']['output'].strip %&gt;</parameter>
                </parameters>
                <messages>
                    <message type="Complete"></message>
                </messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_32</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_28" name="Embed File URL" x="858" y="165">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
embeddedImage=@results['Loop over images']['Value']
imageVAL=embeddedImage[embeddedImage.index(":")+1..embeddedImage.length]
imageVAL=imageVAL[imageVAL.index(",")+1..imageVAL.length]
extra=((imageVAL.index("=")!=nil &amp;&amp; (imageVAL.index("=")+1&lt;imageVAL.length)) ? imageVAL[imageVAL.index('"')+1..imageVAL.length] : "")
extra=extra.gsub('"',"'").gsub('&amp;quot',"'").strip
@@bodyVal.sub!(@results['Image filename']['output'].strip.split(".")[0], "&lt;img src='"+@results['Upload Image']['Public Url']+"'"+extra+"/&gt;")

@@bodyVal
%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_loop_tail_v1_20</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_update_v1" id="kinetic_request_ce_submission_update_v1_29" name="Update Body Value" x="487" y="261">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission being updated.">&lt;%= @submission['Id']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="state" label="State" menu="" required="false" tooltip="The value used to set the submission state."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="values" label="Values" menu="" required="false" tooltip="A JSON map of field names to values that should be set.">&lt;%= @results['Load Body Value']['Answer Set'] %&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_get_answers_v2_30</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_get_answers_v2" id="kinetic_request_ce_submission_get_answers_v2_30" name="Load Body" x="330" y="341">
                <version>2</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="submission_id" label="Submission ID" menu="" required="true" tooltip="The id of the submission to retrieve answers for.">&lt;%= @submission['Id']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="mode" label="Mode" menu="All,Some" required="true" tooltip="If 'All' the entire set of fields will be used.  If 'Some' the fields listed in the 'Included Fields' parameter will be used.  **In both cases, fields listed in the 'Excluded Fields' parameter will never be included in the generated output.**">Some</parameter>
                    <parameter dependsOnId="mode" dependsOnValue="Some" id="included_fields" label="Included Fields" menu="" required="false" tooltip="A comma separated list of field names that should be explicitly included in the field list.  This is only required if the 'Mode' parameter is set to 'Some'.  Whitespace matters; ensure there are no spaces after a comma separating the field names (unless the field names includes a preceding space).">Body</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="excluded_fields" label="Excluded Fields" menu="" required="false" tooltip="A comma separated list of field names that should be explicitly excluded from the field list.  Fields included in this list will be excluded even if they are included in the 'Included Fields' parameter.  Whitespace matters; ensure there are no spaces after a comma separating the field names (unless the field name includes a preceding space)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="field_aliases" label="Field Aliases" menu="" required="false" tooltip="A specially formatted mapping of field names in the answer hash to labels to be used in the answer set.  This is necessary when an answer should be forwarded via answer set, but the field name varies from form to form.  The alias format is as follows:  OldQuestionLabel=NewQuestionLabel,RequesterFirstName=FirstName."></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_notification_variables_build_v1_34</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_31" name="Work Directory" x="142" y="137">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%=require 'fileutils'
wrkDir='/root/gbmember_files'
FileUtils.mkdir_p wrkDir
wrkDir%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_get_answers_v2_33</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_32" name="Delete File" x="891" y="80">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%
filename=@results['Work Directory']['output']+@results['Image filename']['output'].strip
File.delete(filename)
%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_28</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_get_answers_v2" id="kinetic_request_ce_submission_get_answers_v2_33" name="Load Body Value" x="423" y="116">
                <version>2</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="submission_id" label="Submission ID" menu="" required="true" tooltip="The id of the submission to retrieve answers for.">&lt;%= @submission['Id']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="mode" label="Mode" menu="All,Some" required="true" tooltip="If 'All' the entire set of fields will be used.  If 'Some' the fields listed in the 'Included Fields' parameter will be used.  **In both cases, fields listed in the 'Excluded Fields' parameter will never be included in the generated output.**">Some</parameter>
                    <parameter dependsOnId="mode" dependsOnValue="Some" id="included_fields" label="Included Fields" menu="" required="false" tooltip="A comma separated list of field names that should be explicitly included in the field list.  This is only required if the 'Mode' parameter is set to 'Some'.  Whitespace matters; ensure there are no spaces after a comma separating the field names (unless the field names includes a preceding space).">Body</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="excluded_fields" label="Excluded Fields" menu="" required="false" tooltip="A comma separated list of field names that should be explicitly excluded from the field list.  Fields included in this list will be excluded even if they are included in the 'Included Fields' parameter.  Whitespace matters; ensure there are no spaces after a comma separating the field names (unless the field name includes a preceding space)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="field_aliases" label="Field Aliases" menu="" required="false" tooltip="A specially formatted mapping of field names in the answer hash to labels to be used in the answer set.  This is necessary when an answer should be forwarded via answer set, but the field name varies from form to form.  The alias format is as follows:  OldQuestionLabel=NewQuestionLabel,RequesterFirstName=FirstName."></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_update_v1_29</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_notification_variables_build_v1" id="kinetic_request_ce_notification_variables_build_v1_34" name="Build Variables" x="244" y="424">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Slug of the space to retrieve variables from."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="kapp_slug" label="Kapp Slug" menu="" required="false" tooltip="The Slug of the kapp to retrieve variables from.">&lt;%= @kapp['Slug']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="form_slug" label="Form Slug" menu="" required="false" tooltip="The Slug of the form to retrieve variables from.">&lt;%= @form['Slug']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="submission_id" label="Submission Id" menu="" required="false" tooltip="The id of the submission to retrieve variables from.">&lt;%= @submission['Id']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="username" label="CE Username" menu="" required="false" tooltip="The username of the user to retrieve variables for (CE USERS ONLY)"></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="addt_vars" label="Additional Variables" menu="" required="false" tooltip="A JSON String of additional Variables to be used in Replacements"></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="backups" label="Backup Variables" menu="" required="false" tooltip="A JSON String of Backup Variables to be used in Replacements if Missing"></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utility_json_to_xml_v1_16</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_35" name="Resolve Names" x="821" y="298">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
@results['Load Body']['Body'].gsub!("member(&amp;#039;ID&amp;#039;)", @results['Retrieve member']['ID'])
@results['Load Body']['Body'].gsub!("member('ID')", @results['Retrieve member']['ID'])
@results['Load Body']['Body'].gsub!("member(&amp;#039;First Name&amp;#039;)", JSON.parse(@results['Retrieve member']['Values JSON'])["First Name"])
@results['Load Body']['Body'].gsub!("member('First Name')", JSON.parse(@results['Retrieve member']['Values JSON'])["First Name"])
@results['Load Body']['Body'].gsub!("member(&amp;#039;Last Name&amp;#039;)", JSON.parse(@results['Retrieve member']['Values JSON'])["Last Name"])
@results['Load Body']['Body'].gsub!("member('Last Name')", JSON.parse(@results['Retrieve member']['Values JSON'])["Last Name"])

@results['Load Body']['Body'].gsub!("${date}",  DateTime.now.strftime("%d %B %Y"))

@results['Load Body']['Body']
%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_36</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_36" name="Replace Variables" x="1040" y="221">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%=
content=@results['Resolve Names']['output']
replace_values=JSON.parse(@results['Build Variables']['Replacement Variables'])
replace_values.keys.each{|key|
  content = content.gsub(/\$\{#{key}\('(.*?)'\)\}/) do
    if replace_values[key].has_key?($1)
      replace_values[key][$1]
    else
      "${#{key}('#{$1}')}"
    end
  end
}
content=content.gsub(/\$\{space\}/, @space['Slug'])

endIdx=0
while !content.index("&lt;a href",endIdx).nil?
  idx=content.index("&lt;a href", endIdx)
  endIdx = content.index('"', idx + '&lt;a href="'.length);
  url = content.slice(idx + '&lt;a href="'.length, endIdx-(idx+ '&lt;a href="'.length));
  encodeVal = Base64.encode64(url).gsub("\n","");
  newUrl = "https://gbbilling.com.au:8443/billingservice/goToUrl/#{@space['Slug']}/__campaign_id__/__member_id__/#{encodeVal}"
  
  content = content.sub(url, newUrl);  
end

content
%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">smtp_email_send_v1_41</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_retrieve_v2" id="kinetic_request_ce_submission_retrieve_v2_40" name="Retrieve member" x="638" y="385">
                <version>2</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="retrieve_by" label="Retrieve By" menu="Id,Query" required="true" tooltip="How to retrieve the submission. Id or Query.">Id</parameter>
                    <parameter dependsOnId="retrieve_by" dependsOnValue="Query" id="kapp_slug" label="Kapp Slug" menu="" required="true" tooltip="Slug of the kapp to query"></parameter>
                    <parameter dependsOnId="retrieve_by" dependsOnValue="Query" id="form_slug" label="Form Slug" menu="" required="true" tooltip="Slug of the form to query"></parameter>
                    <parameter dependsOnId="retrieve_by" dependsOnValue="Query" id="query" label="Query" menu="" required="true" tooltip="A query that will retrieve a single submission"></parameter>
                    <parameter dependsOnId="retrieve_by" dependsOnValue="Id" id="submission_id" label="Submission Id" menu="" required="true" tooltip="The id of the submission being retrieved.">&lt;%=@results['Loop over ids']['Value']%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">utilities_echo_v1_35</task>
                </dependents>
            </task>
            <task definition_id="smtp_email_send_v1" id="smtp_email_send_v1_41" name="SMTP Email Send" x="1217" y="374">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="from" label="From (email address)" menu="" required="true" tooltip="The email address of the simulated sender.">&lt;%=@values['From']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="to" label="To (email address)" menu="" required="true" tooltip="The email address of the intended recipient.">&lt;%=JSON.parse(@results['Retrieve member']['Values JSON'])["Email"].concat(JSON.parse(@results['Retrieve member']['Values JSON'])["Additional Email"] == nil ? "" : ("," + JSON.parse(@results['Retrieve member']['Values JSON'])["Additional Email"]))%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="subject" label="Subject" menu="" required="true" tooltip="The subject of the email.">&lt;%=@values['Subject']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="htmlbody" label="HTML Body" menu="" required="true" tooltip="HTML representing the body of a rich email.">&lt;%=@results['Replace Variables']['output']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="textbody" label="Alternate (text) Body" menu="" required="false" tooltip="A plaintext message that will be displayed if the recipient can't display multipart HTML emails.">&lt;%=@results['Replace Variables']['output']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="attachments" label="Email Attachments" menu="" required="false" tooltip="Email Attachments if any.">&lt;%=@values['Attachments']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="fieldname" label="Attachment Field Name" menu="" required="false" tooltip="Attachment Field Name">Attachments</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="memberId" label="Member Id" menu="" required="false" tooltip="Member Id">&lt;%=@results['Loop over ids']['Value']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="campaignId" label="Campaign Id" menu="" required="false" tooltip="Campaign Id">&lt;%=@submission['Id']%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space" label="Space slug" menu="" required="false" tooltip="Space slug">&lt;%=@space['Slug']%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="For Member" type="Complete" value="@results['Retrieve member']['Form Name']==&quot;Member&quot;">kinetic_request_ce_submission_create_v1_42</task>
                    <task label="For Lead" type="Complete" value="@results['Retrieve member']['Form Name']==&quot;Lead&quot;">kinetic_request_ce_submission_create_v1_43</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_create_v1" id="kinetic_request_ce_submission_create_v1_42" name="Create Member Email Activity" x="898" y="492">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="kapp_slug" label="Kapp Slug" menu="" required="true" tooltip="The slug of the Kapp the submission is for.">gbmembers</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="form_slug" label="Form Slug" menu="" required="true" tooltip="The slug of the form the submission is for.">member-activities</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="values" label="Values" menu="" required="false" tooltip="JSON map of submission field values.">&lt;%=
campaignId = @submission["Id"]
subject= @values["Subject"]
sentDate = @values["Sent Date"]
newEmail = {}
newEmail["Campaign Id"] = campaignId
newEmail["Subject"] = subject
newEmail["Sent Date"] = sentDate

values = {}
values["Member ID"] = @results['Retrieve member']['ID']
values["Type"] = "Email"
values["Direction"] = "Outbound"
values["Content"] = newEmail.to_json

values.to_json
%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_update_v1_14</task>
                </dependents>
            </task>
            <task definition_id="kinetic_request_ce_submission_create_v1" id="kinetic_request_ce_submission_create_v1_43" name="Create Lead Email Activity" x="1284" y="626">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="error_handling" label="Error Handling" menu="Error Message,Raise Error" required="true" tooltip="Determine what to return if an error is encountered.">Error Message</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="space_slug" label="Space Slug" menu="" required="false" tooltip="The Space the submission is being retrieved from (defaults to info value if not provided)."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="kapp_slug" label="Kapp Slug" menu="" required="true" tooltip="The slug of the Kapp the submission is for.">gbmembers</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="form_slug" label="Form Slug" menu="" required="true" tooltip="The slug of the form the submission is for.">lead-activities</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="values" label="Values" menu="" required="false" tooltip="JSON map of submission field values.">&lt;%=
campaignId = @submission["Id"]
subject= @values["Subject"]
sentDate = @values["Sent Date"]
newEmail = {}
newEmail["Campaign Id"] = campaignId
newEmail["Subject"] = subject
newEmail["Sent Date"] = sentDate

values = {}
values["Lead ID"] = @results['Retrieve member']['ID']
values["Type"] = "Email"
values["Direction"] = "Outbound"
values["Content"] = newEmail.to_json

values.to_json
%&gt;</parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_name" label="Current Page Name" menu="" required="false" tooltip="Set the current page name."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="current_page_navigation" label="Current Page Navigation" menu="" required="false" tooltip="Set the current page navigation."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="origin_id" label="Origin ID" menu="" required="false" tooltip="Set the origin ID."></parameter>
                    <parameter dependsOnId="" dependsOnValue="" id="parent_id" label="Parent ID" menu="" required="false" tooltip="Set the parent ID."></parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">kinetic_request_ce_submission_update_v1_14</task>
                </dependents>
            </task>
            <task definition_id="system_junction_v1" id="system_junction_v1_44" name="continue" x="822" y="673">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>false</visible>
                <parameters></parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_loop_tail_v1_4</task>
                </dependents>
            </task>
            <task definition_id="utilities_echo_v1" id="utilities_echo_v1_45" name="Body Variable" x="421" y="-117">
                <version>1</version>
                <configured>true</configured>
                <defers>false</defers>
                <deferrable>false</deferrable>
                <visible>true</visible>
                <parameters>
                    <parameter dependsOnId="" dependsOnValue="" id="input" label="Input" menu="" required="true" tooltip="">&lt;%
 @@bodyVal=@results['Load Body Value']['Body'].gsub('"',"'")
%&gt;
&lt;%=@bodyVal%&gt;</parameter>
                </parameters>
                <messages></messages>
                <dependents>
                    <task label="" type="Complete" value="">system_loop_head_v1_19</task>
                </dependents>
            </task>
        </request>
    </taskTree>
</tree>